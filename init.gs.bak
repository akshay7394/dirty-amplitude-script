function createOrRetrieveAmplitudeSheet() {
  // Access script properties to store persistent data
  var scriptProperties = PropertiesService.getScriptProperties();
  var firstRun = scriptProperties.getProperty('first_run');
  var sheetId = scriptProperties.getProperty('sheet_id');

  if (firstRun === 'finished') {
    // If the script has already run before, retrieve and log the existing sheet URL
    var existingSheet = SpreadsheetApp.openById(sheetId);
    Logger.log('Existing Amplitude Cost Sync Sheet: ' + existingSheet.getUrl());
    return existingSheet.getUrl();
  } else {
    // Create a new spreadsheet if it's the first run
    var newSpreadsheet = SpreadsheetApp.create("New Amplitude Cost Sync Sheet");
    var sheet = newSpreadsheet.getActiveSheet();
    
    // Rename the default sheet
    sheet.setName("Amplitude Cost sync");
    
    // Define the header row with only the columns used in the original script
    var headers = [
      "Timestamp",
      "Date",
      "Event_name",
      "Channel",
      "Investment",
      "Vendor",
      "Group",
      "Cost Owner"
    ];
    
    // Add headers to the first row of the sheet
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // Format the header row to be bold
    sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");
    
    // Auto-resize columns to fit content
    sheet.autoResizeColumns(1, headers.length);
    
    // Save the new sheet ID and set first_run to finished in script properties
    scriptProperties.setProperty('sheet_id', newSpreadsheet.getId());
    scriptProperties.setProperty('first_run', 'finished');
    
    // Return the URL of the new spreadsheet
    return newSpreadsheet.getUrl();
  }
}

// Function to create a dialog for creating or retrieving the sheet
function createNewSheetDialog() {
  var ui = SpreadsheetApp.getUi();
  var scriptProperties = PropertiesService.getScriptProperties();
  var firstRun = scriptProperties.getProperty('first_run');

  if (firstRun === 'finished') {
    // If a sheet has already been created, display its URL
    var sheetId = scriptProperties.getProperty('sheet_id');
    var existingSheet = SpreadsheetApp.openById(sheetId);
    ui.alert('Existing Sheet', 'An Amplitude Cost Sync sheet already exists. You can access it at: ' + existingSheet.getUrl(), ui.ButtonSet.OK);
  } else {
    // If no sheet exists, prompt the user to create one
    var response = ui.alert('Create New Sheet', 'Do you want to create a new Amplitude Cost Sync sheet?', ui.ButtonSet.YES_NO);

    if (response == ui.Button.YES) {
      // User confirmed, create the new sheet
      var newSheetUrl = createOrRetrieveAmplitudeSheet();
      ui.alert('New sheet created successfully. URL: ' + newSheetUrl);
    } else {
      // User canceled the operation
      ui.alert('New sheet creation canceled.');
    }
  }
}
